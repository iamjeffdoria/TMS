    {% extends 'myapp/base.html' %}
    {% load static %}
    {% block content %}

    <style>
           .table-responsive {
        font-size: 0.95rem;
        overflow-x: auto;
    }
    .table th, .table td {
        padding: 0.75rem;
        vertical-align: middle;
    }
    </style>

                        <!-- DataTales Example -->
                        <div class="card shadow mb-4">
                           <div class="card-header py-3 d-flex justify-content-between align-items-center">

                              <h6 class="m-0 font-weight-bold text-dark">Mayor's Permit Pedicab Records</h6>

                         <div class="btn-group">
                              <button class="btn btn-sm btn-success" data-toggle="modal" data-target="#importModal">
                                  <i class="fas fa-file-import"></i> Import File
                              </button>

                              <!-- EXPORT DROPDOWN -->
                              <div class="btn-group">
                                  <button type="button" class="btn btn-sm btn-danger dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                      <i class="fas fa-file-export"></i> Export
                                  </button>
                                  <div class="dropdown-menu">
                                      <a class="dropdown-item" href="{% url 'export-mayors-permit' %}?format=csv">
                                          <i class="fas fa-file-csv"></i> Export as CSV
                                      </a>
                                      <a class="dropdown-item" href="{% url 'export-mayors-permit' %}?format=excel">
                                          <i class="fas fa-file-excel"></i> Export as Excel
                                      </a>
                                  </div>
                              </div>

                              <button class="btn btn-sm btn-info" data-toggle="modal" data-target="#addPermitModal">
                                  <i class="fas fa-plus"></i> Add New Permit
                              </button>
                          </div>

                          </div>

                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-bordered table-hover" id="dataTable" width="100%" cellspacing="0">
                                    <thead>
                                  <tr>
                                      <th>Control No</th>
                                      <th style="display:none;">Status</th>
                                      <th>Name</th>
                                      <th>Address</th>
                                      <th>Business Name</th>
                                      <th>Motorized Operation</th>
                                      <th>OR No</th>
                                      <th>Amount Paid</th>
                                      <th>Issue Date</th>
                                      <th>Expiry Date</th>
                                      <th>Issued At</th>
                                      <th>Mayor</th>
                                      <th>Quarter</th>
                                      <th>Action</th>
                                  </tr>
                                  <tr>
                                      <th><input type="text"  class="form-control form-control-sm border-secondary" /></th>
                                      <th></th>
                                      <th><input type="text" class="form-control form-control-sm border border-secondary" /></th>
                                      <th><input type="text" class="form-control form-control-sm border border-secondary" /></th>
                                      <th><input type="text" class="form-control form-control-sm border border-secondary" /></th>
                                      <th><input type="text" class="form-control form-control-sm border border-secondary" /></th>
                                      <th><input type="text" class="form-control form-control-sm border border-secondary" /></th>
                                      <th><input type="text" class="form-control form-control-sm border border-secondary" /></th>
                                      <th><input type="text" class="form-control form-control-sm border border-secondary" /></th>
                                      <th><input type="text" class="form-control form-control-sm border border-secondary" /></th>
                                      <th><input type="text" class="form-control form-control-sm border border-secondary" /></th>
                                      <th><input type="text" class="form-control form-control-sm border border-secondary" /></th>
                                      <th><input type="text" class="form-control form-control-sm border border-secondary" /></th>
                                      <th></th>
                                  </tr>
                                </thead>

                                        <tfoot>
                                            <tr>
                                                <th>Control No</th>
                                                <th style="display:none;">Status</th>
                                                <th>Name</th>
                                                <th>Address</th>
                                                <th>Business Name</th>
                                                <th>Motorized Operation</th>
                                                <th>OR No</th>
                                                <th>Amount Paid</th>
                                                <th>Issue Date</th>
                                                <th>Expiry Date</th>
                                                <th>Issued At</th>
                                                <th>Mayor</th>
                                                <th>Quarter</th>
                                                <th>Action</th>
                                               
                                            </tr>
                                        </tfoot>
                                        <tbody>
                                         
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
    <!-- View Modal -->
    <div class="modal fade" id="viewModal" tabindex="-1" aria-labelledby="viewModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content shadow-lg border-0">

          <!-- Header -->
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title font-weight-bold" id="viewModalLabel">
              <i class="fas fa-file-alt mr-2"></i> Permit Information
            </h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>

          <!-- Body -->
          <div class="modal-body py-4">
            <div class="container-fluid">
              <div class="row" id="modalContent">
                <!-- Injected by JS -->
              </div>
            </div>
          </div>

          <!-- Footer -->
          <div class="modal-footer bg-light">
            <button type="button" class="btn btn-danger" data-dismiss="modal">
              <i class="fas fa-times mr-1"></i> Close
            </button>
          </div>

        </div>
      </div>
    </div>

<!-- Update Modal -->
    <div class="modal fade" id="updateModal" tabindex="-1" aria-labelledby="updateModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content shadow-lg border-0">

          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title font-weight-bold">
              <i class="fas fa-edit mr-2"></i> Update Mayor's Permit
            </h5>
            <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
              <span>&times;</span>
            </button>
          </div>

          <div class="modal-body">

            <form id="updateForm">

              {% csrf_token %}

              <input type="hidden" id="u_id">

              <div class="form-row">
                <div class="col-lg-4 col-md-6 mb-3">
                  <label class="font-weight-bold">Control No</label>
                  <div class="input-group">
                    <div class="input-group-prepend">
                      <span class="input-group-text"><i class="fas fa-barcode"></i></span>
                    </div>
                    <input type="text" id="u_control_no" class="form-control">
                  </div>
                </div>

                <div class="col-lg-4 col-md-6 mb-3">
                  <label class="font-weight-bold">Status</label>
                  <div class="input-group">
                    <div class="input-group-prepend">
                      <span class="input-group-text"><i class="fas fa-check-circle"></i></span>
                    </div>
                    <select id="u_status" class="form-control">
                      <option value="active">Active</option>
                      <option value="inactive">Inactive</option>
                      <option value="expired">Expired</option>
                    </select>
                  </div>
                </div>

                <div class="col-lg-4 col-md-6 mb-3">
                  <label class="font-weight-bold">Name</label>
                  <div class="input-group">
                    <div class="input-group-prepend">
                      <span class="input-group-text"><i class="fas fa-user"></i></span>
                    </div>
                    <input type="text" id="u_name" class="form-control">
                  </div>
                </div>

                <div class="col-lg-4 col-md-6 mb-3">
                  <label class="font-weight-bold">Address</label>
                  <div class="input-group">
                    <div class="input-group-prepend">
                      <span class="input-group-text"><i class="fas fa-map-marker-alt"></i></span>
                    </div>
                    <input type="text" id="u_address" class="form-control">
                  </div>
                </div>

                <div class="col-lg-4 col-md-6 mb-3">
                  <label class="font-weight-bold">Business Name</label>
                  <div class="input-group">
                    <div class="input-group-prepend">
                      <span class="input-group-text"><i class="fas fa-building"></i></span>
                    </div>
                    <input type="text" id="u_business_name" class="form-control">
                  </div>
                </div>

                <div class="col-lg-4 col-md-6 mb-3">
                  <label class="font-weight-bold">Motorized Operation</label>
                  <div class="input-group">
                    <div class="input-group-prepend">
                      <span class="input-group-text"><i class="fas fa-bicycle"></i></span>
                    </div>
                    <input type="text" id="u_motorized" class="form-control">
                  </div>
                </div>

                <div class="col-lg-4 col-md-6 mb-3">
                  <label class="font-weight-bold">OR No</label>
                  <div class="input-group">
                    <div class="input-group-prepend">
                      <span class="input-group-text"><i class="fas fa-receipt"></i></span>
                    </div>
                    <input type="text" id="u_or_no" class="form-control">
                  </div>
                </div>

                <div class="col-lg-4 col-md-6 mb-3">
                  <label class="font-weight-bold">Amount Paid</label>
                  <div class="input-group">
                    <div class="input-group-prepend">
                      <span class="input-group-text"><i class="fas fa-peso-sign"></i></span>
                    </div>
                    <input type="number" id="u_amount_paid" class="form-control">
                  </div>
                </div>

                <div class="col-lg-4 col-md-6 mb-3">
                  <label class="font-weight-bold">Issue Date</label>
                  <div class="input-group">
                    <div class="input-group-prepend">
                      <span class="input-group-text"><i class="fas fa-calendar-plus"></i></span>
                    </div>
                    <input type="date" id="u_issue_date" class="form-control">
                  </div>
                </div>

                <div class="col-lg-4 col-md-6 mb-3">
                  <label class="font-weight-bold">Expiry Date</label>
                  <div class="input-group">
                    <div class="input-group-prepend">
                      <span class="input-group-text"><i class="fas fa-calendar-times"></i></span>
                    </div>
                    <input type="date" id="u_expiry_date" class="form-control">
                  </div>
                </div>

                <div class="col-lg-4 col-md-6 mb-3">
                  <label class="font-weight-bold">Issued At</label>
                  <div class="input-group">
                    <div class="input-group-prepend">
                      <span class="input-group-text"><i class="fas fa-map-pin"></i></span>
                    </div>
                    <input type="text" id="u_issued_at" class="form-control">
                  </div>
                </div>

                <div class="col-lg-4 col-md-6 mb-3">
                  <label class="font-weight-bold">Mayor</label>
                  <div class="input-group">
                    <div class="input-group-prepend">
                      <span class="input-group-text"><i class="fas fa-user-tie"></i></span>
                    </div>
                    <input type="text" id="u_mayor" class="form-control">
                  </div>
                </div>

                <div class="col-lg-4 col-md-6 mb-3">
                  <label class="font-weight-bold">Quarter</label>
                  <div class="input-group">
                    <div class="input-group-prepend">
                      <span class="input-group-text"><i class="fas fa-chart-line"></i></span>
                    </div>
                    <select id="u_quarter" class="form-control">
                      <option value="First Quarter">Q1</option>
                      <option value="Second Quarter">Q2</option>
                      <option value="Third Quarter">Q3</option>
                      <option value="Fourth Quarter">Q4</option>
                    </select>
                  </div>
                </div>

              </div>

            </form>

          </div>

          <div class="modal-footer bg-light">
            <button class="btn btn-success" id="saveUpdateBtn">
              <i class="fas fa-check"></i> Save Changes
            </button>
            <button class="btn btn-danger" data-dismiss="modal">
              Close
            </button>
          </div>

        </div>
      </div>
    </div>
    
<!-- Add Permit Modal -->
<div class="modal fade" id="addPermitModal" tabindex="-1" aria-labelledby="addPermitModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content shadow-lg border-0">

      <div class="modal-header bg-info text-white">
        <h5 class="modal-title font-weight-bold" id="addPermitModalLabel">
          <i class="fas fa-plus mr-2"></i> Add New Mayor's Permit
        </h5>
        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
          <span>&times;</span>
        </button>
      </div>

      <div class="modal-body">
        <form id="addPermitForm">
          {% csrf_token %}
          <div class="form-row">

            <div class="col-lg-4 col-md-6 mb-3">
              <label class="font-weight-bold">Control No</label>
              <div class="input-group">
                <div class="input-group-prepend">
                  <span class="input-group-text"><i class="fas fa-barcode"></i></span>
                </div>
                <input type="text" name="control_no" class="form-control" required>
              </div>
            </div>

            <div class="col-lg-4 col-md-6 mb-3">
              <label class="font-weight-bold">Status</label>
              <div class="input-group">
                <div class="input-group-prepend">
                  <span class="input-group-text"><i class="fas fa-check-circle"></i></span>
                </div>
                <select name="status" class="form-control">
                  <option value="active">Active</option>
                  <option value="inactive">Inactive</option>
                  <option value="expired">Expired</option>
                </select>
              </div>
            </div>

            <div class="col-lg-4 col-md-6 mb-3">
              <label class="font-weight-bold">Name</label>
              <div class="input-group">
                <div class="input-group-prepend">
                  <span class="input-group-text"><i class="fas fa-user"></i></span>
                </div>
                <input type="text" name="name" class="form-control" required>
              </div>
            </div>

            <div class="col-lg-4 col-md-6 mb-3">
              <label class="font-weight-bold">Address</label>
              <div class="input-group">
                <div class="input-group-prepend">
                  <span class="input-group-text"><i class="fas fa-map-marker-alt"></i></span>
                </div>
                <input type="text" name="address" class="form-control" required>
              </div>
            </div>

            <div class="col-lg-4 col-md-6 mb-3">
              <label class="font-weight-bold">Business Name</label>
              <div class="input-group">
                <div class="input-group-prepend">
                  <span class="input-group-text"><i class="fas fa-building"></i></span>
                </div>
                <input type="text" name="business_name" class="form-control">
              </div>
            </div>

            <div class="col-lg-4 col-md-6 mb-3">
              <label class="font-weight-bold">Motorized Operation</label>
              <div class="input-group">
                <div class="input-group-prepend">
                  <span class="input-group-text"><i class="fas fa-bicycle"></i></span>
                </div>
                <input type="text" name="motorized_operation" class="form-control">
              </div>
            </div>

            <div class="col-lg-4 col-md-6 mb-3">
              <label class="font-weight-bold">OR No</label>
              <div class="input-group">
                <div class="input-group-prepend">
                  <span class="input-group-text"><i class="fas fa-receipt"></i></span>
                </div>
                <input type="text" name="or_no" class="form-control" required>
              </div>
            </div>

            <div class="col-lg-4 col-md-6 mb-3">
              <label class="font-weight-bold">Amount Paid</label>
              <div class="input-group">
                <div class="input-group-prepend">
                  <span class="input-group-text"><i class="fas fa-peso-sign"></i></span>
                </div>
                <input type="number" name="amount_paid" class="form-control" required>
              </div>
            </div>

            <div class="col-lg-4 col-md-6 mb-3">
              <label class="font-weight-bold">Issue Date</label>
              <div class="input-group">
                <div class="input-group-prepend">
                  <span class="input-group-text"><i class="fas fa-calendar-plus"></i></span>
                </div>
                <input type="date" name="issue_date" class="form-control" required>
              </div>
            </div>

            <div class="col-lg-4 col-md-6 mb-3">
              <label class="font-weight-bold">Expiry Date</label>
              <div class="input-group">
                <div class="input-group-prepend">
                  <span class="input-group-text"><i class="fas fa-calendar-times"></i></span>
                </div>
                <input type="date" name="expiry_date" class="form-control" required>
              </div>
            </div>

            <div class="col-lg-4 col-md-6 mb-3">
              <label class="font-weight-bold">Issued At</label>
              <div class="input-group">
                <div class="input-group-prepend">
                  <span class="input-group-text"><i class="fas fa-map-pin"></i></span>
                </div>
                <input type="text" name="issued_at" class="form-control">
              </div>
            </div>

            <div class="col-lg-4 col-md-6 mb-3">
              <label class="font-weight-bold">Mayor</label>
              <div class="input-group">
                <div class="input-group-prepend">
                  <span class="input-group-text"><i class="fas fa-user-tie"></i></span>
                </div>
                <input type="text" name="mayor" class="form-control">
              </div>
            </div>

            <div class="col-lg-4 col-md-6 mb-3">
              <label class="font-weight-bold">Quarter</label>
              <div class="input-group">
                <div class="input-group-prepend">
                  <span class="input-group-text"><i class="fas fa-chart-line"></i></span>
                </div>
                <select name="quarter" class="form-control">
                  <option value="First Quarter">Q1</option>
                  <option value="Second Quarter">Q2</option>
                  <option value="Third Quarter">Q3</option>
                  <option value="Fourth Quarter">Q4</option>
                </select>
              </div>
            </div>

          </div>
        </form>
      </div>

      <div class="modal-footer bg-light">
        <button class="btn btn-success" id="saveAddPermitBtn">
          <i class="fas fa-check"></i> Save Permit
        </button>
        <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
      </div>

    </div>
  </div>
</div>

<!-- History Modal -->
<div class="modal fade" id="historyModal" tabindex="-1" aria-labelledby="historyModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content shadow-lg border-0">

      <!-- Header -->
      <div class="modal-header bg-warning text-dark">
        <h5 class="modal-title font-weight-bold" id="historyModalLabel">
          <i class="fas fa-history mr-2"></i> Status History
        </h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <!-- Body -->
      <div class="modal-body py-4">
        <div class="container-fluid">
          <!-- Permit Info -->
          <div class="row mb-3">
            <div class="col-md-4">
              <div class="small text-muted">Control No</div>
              <div class="font-weight-bold" id="history-control-no">-</div>
            </div>
            <div class="col-md-4">
              <div class="small text-muted">Name</div>
              <div class="font-weight-bold" id="history-name">-</div>
            </div>
            <div class="col-md-4">
              <div class="small text-muted">Current Status</div>
              <div class="font-weight-bold" id="history-current-status">-</div>
            </div>
          </div>

          <hr>

          <!-- History Timeline with Scrollbar -->
          <div class="row">
            <div class="col-12">
              <h6 class="font-weight-bold mb-3">Status Change History</h6>
              <div id="historyTimeline" style="max-height: 300px; overflow-y: auto; padding-right: 10px;">
                <div class="text-center text-muted py-4">
                  <i class="fas fa-spinner fa-spin fa-2x"></i>
                  <p class="mt-2">Loading history...</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <div class="modal-footer bg-light">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">
          <i class="fas fa-times mr-1"></i> Close
        </button>
      </div>

    </div>
  </div>
</div>

    <script>
    document.addEventListener("DOMContentLoaded", function () {


      document.querySelectorAll(".btn-view").forEach(button => {
      button.addEventListener("click", function () {

          let $tr = $(this).closest("tr");
          let row = table.row($tr);   // DataTables row
          let data = row.data();                        // get ALL columns including hidden

          let fields = [
              "Control No", "Status", "Name", "Address", "Business Name",
              "Motorized Operation", "OR No", "Amount Paid", "Issue Date",
              "Expiry Date", "Issued At", "Mayor", "Quarter"
          ];

          let html = "";

          for (let i = 0; i < fields.length; i++) {
              let value;

              // Status: prefer data-search or cell text, show capitalized
          if (i === 1) {
              let rawStatus = $tr.find("td:eq(1)").data("search");

                  let badgeClass = "badge-secondary";
                  if (rawStatus === "active") badgeClass = "badge-success";
                  else if (rawStatus === "inactive") badgeClass = "badge-warning";
                  else if (rawStatus === "expired") badgeClass = "badge-danger";

                  value = `<span class="badge ${badgeClass}">${rawStatus.charAt(0).toUpperCase() + rawStatus.slice(1)}</span>`;
              }
          else {
                  value = (data[i] === undefined || data[i] === null) ? '' : data[i];
                  if (typeof value === 'object') {
                      value = $tr.find(`td:eq(${i})`).text().trim();
                  }
              }

              if (!value) value = '&mdash;';

              html += `
                <div class="col-md-4 col-sm-6 mb-4">
                  <div class="small text-muted">${fields[i]}</div>
                  <div class="font-weight-bold">${value}</div>
                </div>
              `;
          }

          document.getElementById("modalContent").innerHTML = html;
          $("#viewModal").modal("show");
      });
  });

        function toInputDate(dateStr) {
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) return dateStr;
            let d = new Date(dateStr);
            if (isNaN(d.getTime())) return "";
            let m = ("0" + (d.getMonth() + 1)).slice(-2);
            let day = ("0" + d.getDate()).slice(-2);
            return `${d.getFullYear()}-${m}-${day}`;
        }

  document.querySelectorAll(".btn-update").forEach(button => {
    button.addEventListener("click", function () {

        let $tr = $(this).closest("tr");  // the table row
        let row = table.row($tr);
        let data = row.data();   // array including hidden columns

        document.getElementById("u_id").value = this.dataset.id;

        document.getElementById("u_control_no").value = data[0];

        // âœ… Use data-search instead of data[1]
        let status = $tr.find("td:eq(1)").data("search"); 
        document.getElementById("u_status").value = status;

        document.getElementById("u_name").value = data[2];
        document.getElementById("u_address").value = data[3];
        document.getElementById("u_business_name").value = data[4];
        document.getElementById("u_motorized").value = data[5];
        document.getElementById("u_or_no").value = data[6];
        document.getElementById("u_amount_paid").value = data[7];
        document.getElementById("u_issue_date").value = toInputDate(data[8]);
        document.getElementById("u_expiry_date").value = toInputDate(data[9]);
        document.getElementById("u_issued_at").value = data[10];
        document.getElementById("u_mayor").value = data[11];
        document.getElementById("u_quarter").value = data[12].trim();

        $("#updateModal").modal("show");
    });
});


        // SAVE UPDATE
        document.getElementById("saveUpdateBtn").addEventListener("click", function () {

            let id = document.getElementById("u_id").value;
            let csrftoken = document.querySelector("[name=csrfmiddlewaretoken]").value;

            let formData = new FormData();
            formData.append("control_no", document.getElementById("u_control_no").value);
            formData.append("status", document.getElementById("u_status").value);
            formData.append("name", document.getElementById("u_name").value);
            formData.append("address", document.getElementById("u_address").value);
            formData.append("business_name", document.getElementById("u_business_name").value);
            formData.append("motorized_operation", document.getElementById("u_motorized").value);
            formData.append("or_no", document.getElementById("u_or_no").value);
            formData.append("amount_paid", document.getElementById("u_amount_paid").value);
            formData.append("issue_date", document.getElementById("u_issue_date").value);
            formData.append("expiry_date", document.getElementById("u_expiry_date").value);
            formData.append("issued_at", document.getElementById("u_issued_at").value);
            formData.append("mayor", document.getElementById("u_mayor").value);
            formData.append("quarter", document.getElementById("u_quarter").value);

            fetch(`/mayors-permit/update/${id}/`, {
                method: "POST",
                body: formData,
                headers: { "X-CSRFToken": csrftoken },
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    $("#updateModal").modal("hide");

                    // Show success alert
                    let alertBox = document.createElement("div");
                    alertBox.className = "alert alert-success mt-3";
                    alertBox.innerText = data.message;
                    document.querySelector(".card-body").prepend(alertBox);

                    setTimeout(() => alertBox.remove(), 3000);

                    location.reload(); // Optional: refresh after update
                }
            });

        });
  var table = $('#dataTable').DataTable({
        "processing": true,
        "serverSide": true,
        "ajax": {
            "url": "{% url 'mayors-permit-datatable' %}",
            "type": "GET"
        },
        "pageLength": 10,
        "lengthChange": false,
        "ordering": false,
        "searching": true,
        "dom": 'lrtip',
        "columns": [
            { "data": 0 },  // Control No
            { "data": 1, "visible": false, "searchable": true },  // Status
            { "data": 2 },  // Name
            { "data": 3 },  // Address
            { "data": 4 },  // Business Name
            { 
              "data": 5,   // Motorized Operation (merged with Status)
                "render": function(data, type, row) {
                    var status = row[1];  // Status column
                    var statusBadge = '';
                    
                    if (status) {
                        var badgeClass = '';
                        var statusText = status.charAt(0).toUpperCase() + status.slice(1);
                        
                        if (status.toLowerCase() === 'active') {
                            badgeClass = 'badge-success';
                        } else if (status.toLowerCase() === 'inactive') {
                            badgeClass = 'badge-warning';
                        } else if (status.toLowerCase() === 'expired') {
                            badgeClass = 'badge-danger';
                        } else {
                            badgeClass = 'badge-secondary';
                        }
                        
                        statusBadge = '<br><span class="badge ' + badgeClass + ' badge-sm">' + statusText + '</span>';
                    }
                    
                    return '<span>' + data + '</span>' + statusBadge;
                }
            },
            { "data": 6 },  // OR No
            { "data": 7 },  // Amount Paid
            { "data": 8 },  // Issue Date
            { "data": 9 },  // Expiry Date
            { "data": 10 }, // Issued At
            { "data": 11 }, // Mayor
            { "data": 12 }, // Quarter
            { "data": 13, "orderable": false },  // Action
            { "data": 14 },  // Hidden ID
            { "data": 15 }   // Hidden raw status
        ],
        "columnDefs": [
            {
                "targets": [7, 8, 9, 10, 11, 12],  // Hidden columns
                "visible": false,
                "searchable": true
            },
            {
                "targets": 14,  // ID column
                "visible": false,
                "searchable": false
            },
            {
                "targets": 15,  // Raw status column
                "visible": false,
                "searchable": false
            }
        ]
    });

    // Column search for text inputs
    table.columns().every(function(index) {
        var that = this;
        
        if (index === 1 || index === 13 || index === 14 || index === 15) {
            return;
        }
        
        $('input', this.header()).on('keyup change clear', function() {
            if (that.search() !== this.value) {
                that.search(this.value).draw();
            }
        });
    });

    // Status dropdown filter
    // $('#statusFilter').on('change', function() {
    //     var searchValue = this.value;
    //     table.column(1).search(searchValue).draw();
    // });

    // View button - use event delegation
    $('#dataTable tbody').on('click', '.btn-view', function(e) {
        e.preventDefault();
        
        let row = table.row($(this).closest('tr'));
        let data = row.data();
        
        let fields = [
            "Control No", "Status", "Name", "Address", "Business Name",
            "Motorized Operation", "OR No", "Amount Paid", "Issue Date",
            "Expiry Date", "Issued At", "Mayor", "Quarter"
        ];

        let html = "";
        for (let i = 0; i < fields.length; i++) {
            let value = data[i] || '&mdash;';
            html += `
                <div class="col-md-4 col-sm-6 mb-4">
                    <div class="small text-muted">${fields[i]}</div>
                    <div class="font-weight-bold">${value}</div>
                </div>
            `;
        }

        document.getElementById("modalContent").innerHTML = html;
        $("#viewModal").modal("show");
    });

    function toInputDate(dateStr) {
        if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) return dateStr;
        let d = new Date(dateStr);
        if (isNaN(d.getTime())) return "";
        let m = ("0" + (d.getMonth() + 1)).slice(-2);
        let day = ("0" + d.getDate()).slice(-2);
        return `${d.getFullYear()}-${m}-${day}`;
    }

    // Update button - use event delegation
    $('#dataTable tbody').on('click', '.btn-update', function(e) {
        e.preventDefault();
        
        let row = table.row($(this).closest('tr'));
        let data = row.data();

        document.getElementById("u_id").value = data[14];  // ID from hidden column
        document.getElementById("u_control_no").value = data[0];
        document.getElementById("u_status").value = data[15];  // Raw status from hidden column
        document.getElementById("u_name").value = data[2];
        document.getElementById("u_address").value = data[3];
        document.getElementById("u_business_name").value = data[4];
        document.getElementById("u_motorized").value = data[5];
        document.getElementById("u_or_no").value = data[6];
        document.getElementById("u_amount_paid").value = data[7];
        document.getElementById("u_issue_date").value = toInputDate(data[8]);
        document.getElementById("u_expiry_date").value = toInputDate(data[9]);
        document.getElementById("u_issued_at").value = data[10];
        document.getElementById("u_mayor").value = data[11];
        document.getElementById("u_quarter").value = data[12].trim();

        $("#updateModal").modal("show");
    });

    // Save Update
    document.getElementById("saveUpdateBtn").addEventListener("click", function () {
        let id = document.getElementById("u_id").value;
        let csrftoken = document.querySelector("[name=csrfmiddlewaretoken]").value;

        let formData = new FormData();
        formData.append("control_no", document.getElementById("u_control_no").value);
        formData.append("status", document.getElementById("u_status").value);
        formData.append("name", document.getElementById("u_name").value);
        formData.append("address", document.getElementById("u_address").value);
        formData.append("business_name", document.getElementById("u_business_name").value);
        formData.append("motorized_operation", document.getElementById("u_motorized").value);
        formData.append("or_no", document.getElementById("u_or_no").value);
        formData.append("amount_paid", document.getElementById("u_amount_paid").value);
        formData.append("issue_date", document.getElementById("u_issue_date").value);
        formData.append("expiry_date", document.getElementById("u_expiry_date").value);
        formData.append("issued_at", document.getElementById("u_issued_at").value);
        formData.append("mayor", document.getElementById("u_mayor").value);
        formData.append("quarter", document.getElementById("u_quarter").value);

        fetch(`/mayors-permit/update/${id}/`, {
            method: "POST",
            body: formData,
            headers: { "X-CSRFToken": csrftoken },
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                $("#updateModal").modal("hide");

                let alertBox = document.createElement("div");
                alertBox.className = "alert alert-success mt-3";
                alertBox.innerText = data.message;
                document.querySelector(".card-body").prepend(alertBox);

                setTimeout(() => alertBox.remove(), 3000);
                table.ajax.reload();  // Reload table instead of page refresh
            }
        });
    });

    // Add Permit
    document.getElementById("saveAddPermitBtn").addEventListener("click", function() {
        let form = document.getElementById("addPermitForm");
        let formData = new FormData(form);
        let csrftoken = document.querySelector("[name=csrfmiddlewaretoken]").value;

        fetch("{% url 'add-mayors-permit' %}", {
            method: "POST",
            body: formData,
            headers: { "X-CSRFToken": csrftoken },
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                $("#addPermitModal").modal("hide");

                let alertBox = document.createElement("div");
                alertBox.className = "alert alert-success mt-3";
                alertBox.innerText = data.message;
                document.querySelector(".card-body").prepend(alertBox);

                setTimeout(() => alertBox.remove(), 3000);
                table.ajax.reload();  // Reload table instead of page refresh
            } else {
                alert(data.error || "Failed to add permit.");
            }
        })
        .catch(err => console.error(err));
    });

    // History button - use event delegation
$('#dataTable tbody').on('click', '.btn-history', function(e) {
    e.preventDefault();
    
    let permitId = $(this).data('id');
    
    // Show modal
    $("#historyModal").modal("show");
    
    // Fetch history data
    fetch(`/mayors-permit/history-data/${permitId}/`)
        .then(res => res.json())
        .then(response => {
            if (response.success) {
                let data = response.data;
                
                // Populate permit info
                document.getElementById('history-control-no').textContent = data.permit_info.control_no;
                document.getElementById('history-name').textContent = data.permit_info.name;
                
                // Format current status with badge
                let statusBadge = '';
                if (data.permit_info.current_status === 'active') {
                    statusBadge = '<span class="badge badge-success">Active</span>';
                } else if (data.permit_info.current_status === 'inactive') {
                    statusBadge = '<span class="badge badge-warning">Inactive</span>';
                } else if (data.permit_info.current_status === 'expired') {
                    statusBadge = '<span class="badge badge-danger">Expired</span>';
                }
                document.getElementById('history-current-status').innerHTML = statusBadge;
                
                // Populate history timeline
                let timelineHtml = '';
                if (data.history && data.history.length > 0) {
                    data.history.forEach(record => {
                        timelineHtml += `
                            <div class="card mb-2">
                                <div class="card-body py-2">
                                    <div class="row align-items-center">
                                        <div class="col-md-3">
                                            <small class="text-muted"><i class="fas fa-calendar"></i> ${record.date}</small>
                                        </div>
                                        <div class="col-md-6">
                                            <span class="badge badge-secondary">${record.old_status}</span>
                                            <i class="fas fa-arrow-right mx-2"></i>
                                            <span class="badge badge-primary">${record.new_status}</span>
                                        </div>
                                        <div class="col-md-3 text-right">
                                            <small class="text-muted">${record.changed_by}</small>
                                        </div>
                                    </div>
                                    ${record.reason ? `<div class="row mt-2"><div class="col-12"><small><strong>Reason:</strong> ${record.reason}</small></div></div>` : ''}
                                </div>
                            </div>
                        `;
                    });
                } else {
                    timelineHtml = `
                        <div class="alert alert-info text-center">
                            <i class="fas fa-info-circle"></i> No status change history available
                        </div>
                    `;
                }
                
                document.getElementById('historyTimeline').innerHTML = timelineHtml;
            } else {
                document.getElementById('historyTimeline').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i> ${response.error || 'Failed to load history'}
                    </div>
                `;
            }
        })
        .catch(err => {
            console.error('Error fetching history:', err);
            document.getElementById('historyTimeline').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i> Error loading history data
                </div>
            `;
        });
});
});

    </script>
  

<!-- Import Modal -->
<div class="modal fade" id="importModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">

      <div class="modal-header bg-success text-white">
        <h5 class="modal-title"><i class="fas fa-file-import"></i> Import File</h5>
        <button class="close" data-dismiss="modal">&times;</button>
      </div>

      <form method="POST" enctype="multipart/form-data" action="{% url 'import-mayors-permit' %}">
        {% csrf_token %}

        <div class="modal-body">
          <label><strong>Select CSV or Excel File</strong></label>
          <input type="file" name="csv_file" accept=".csv,.xlsx,.xls" class="form-control" required>
          <small class="form-text text-muted">Supported formats: .csv, .xlsx, .xls</small>
        </div>

        <div class="modal-footer">
          <button type="submit" class="btn btn-success">
            <i class="fas fa-upload"></i> Upload
          </button>
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        </div>

      </form>

    </div>
  </div>
</div>

    {% endblock %}
{% extends 'myapp/base.html' %}
{% load static %}
{% block content %}
<style>
/* Fixed image column */
.table td.image-col,
.table th.image-col {
    width: 70px;
    text-align: center;
    vertical-align: middle;
    padding: 6px;
}

/* Thumbnail styling */
.id-thumb {
    width: 48px;
    height: 48px;
    object-fit: contain; /* IMPORTANT: no ugly crop */
    border-radius: 6px;
    background-color: #f8f9fc;
    border: 1px solid #e3e6f0;
    padding: 2px;
}
/* Styling for the Print Templates */
#print-area, #print-area-2 { display: none; }
@media print {
    /* Reset all default page margins */
    @page {
        size: auto;
        margin: 0mm;
    }
    
    html, body {
        margin: 0 !important;
        padding: 0 !important;
        width: 100%;
        height: 100%;
    }
    
    body * { 
        visibility: hidden; 
    }
    
    /* Only show the active print area */
    #print-area.active, #print-area.active *,
    #print-area-2.active, #print-area-2.active * { 
        visibility: visible; 
    }
    
    #print-area.active, #print-area-2.active {
        display: flex !important;
        position: fixed;
        top: 0; 
        left: 0; 
        width: 100vw; 
        height: 100vh;
        margin: 0 !important;
        padding: 0 !important;
        justify-content: center; 
        align-items: center;
        background: white;
        page-break-after: avoid;
    }

    /* ============================
       PRINT AREA 1 STYLING
    ============================ */
    #print-area .id-card-wrapper {
        position: relative;
        width: 640px;
        height: 1000px;
        margin: 0 auto;
        page-break-inside: avoid;
        transform: scale(0.55); /* Normal ID card size */
    }
    #print-area .template-bg { 
        width: 100%; 
        height: auto; 
        display: block; 
    }

    /* Print Area 1 - Dynamic Photo */
    #print-area .dynamic-photo {
        position: absolute;
        top: 26.4%;
        left: 21.2%;
        transform: translateX(-50%);
        width: 238px;
        height: 218px;
        object-fit: cover;
    }

    /* Print Area 1 - Text Fields */
    #print-area .field {
        position: absolute;
        font-family: Arial, sans-serif;
        font-weight: bold;
        color: rgb(37, 35, 35);
        font-size: 24px;
    }
#print-area .full-name {
    top: 28.5%;
    left: 69%;
    transform: translateX(-50%);
    text-align: center;
    font-size: 24px;
    text-transform: uppercase;
    color: rgb(37, 35, 35);
    
    /* Make it look EXACTLY like the mayor's underline */
    text-decoration: none; 
    border-bottom: 2px solid black;
    padding-bottom: 2px;  /* Space between text and line */
    padding-left: 0px;    /* NO extra padding on sides */
    padding-right: 0px;   /* NO extra padding on sides */
    display: inline-block;
    width: auto;          /* Width fits the text only */
}
#print-area .dm-onate { 
    top: 92%; 
    left: 50%; 
    transform: translateX(-50%);
    text-align: center;
    font-size: 24px;
    
    /* Palitan ang text-decoration ng mga ito: */
    text-decoration: none; 
    border-bottom: 1px solid black; /* Kapal at kulay ng linya */
           /* Gap sa pagitan ng text at linya */
    padding-left: 50px;            /* Lagpas sa kaliwa */
    padding-right: 50px;           /* Lagpas sa kanan */
    display: inline-block;         /* Importante para gumana ang padding */
}
 /* SIGNATURE UNDERLINE - Adjust position here! */
    #print-area .signature-line {
        position: absolute;
        top: 43%;  /* Adjust up/down */
        left: 53.5%; /* Adjust left/right */
        width: 200px; /* Adjust line width */
        border-bottom: 2px solid black; /* Adjust thickness */
        text-align: center;
    }
    #print-area .id-number { top: 48.8%; left: 13%; }
    #print-area .address   { top: 57.8%; left: 21%; width: 50%; line-height: 1.1; }
    #print-area .dob       { top: 71.8%; left: 2%; }
    #print-area .gender    { top: 71.8%; left: 36%; }
    #print-area .or-number { top: 82.7%; left: 2%; }
    #print-area .height    { top: 71.8%; left: 55%; }
    #print-area .weight    { top: 71.8%; left: 83%; }
    #print-area .date-issued  { top: 82.7%; left: 32.5%; }
    #print-area .expiry-date  { top: 82.7%; left: 70%; }

    /* ============================
       PRINT AREA 2 STYLING
    ============================ */
    #print-area-2 .id-card-wrapper {
        position: relative;
        width: 640px;
        height: 1000px;
    }

    #print-area-2 .template-bg { 
        width: 100%; 
        height: auto; 
        display: block; 
    }

    /* Print Area 2 - Dynamic Photo */
    #print-area-2 .dynamic-photo {
        position: absolute;
        top: 16%;
        left: 50%;
        transform: translateX(-50%);
        width: 257px;
        height: 257px;
        object-fit: cover;
        border-radius: 8px;
    }

    /* Print Area 2 - Text Fields */
    #print-area-2 .field {
        position: absolute;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        font-weight: 600;
        color: rgb(20, 20, 20);
        font-size: 26px;
    }
   #print-area-2 .full-name {
        top: 59.1%;
        left: 50%;
        transform: translateX(-50%);
        width: 90%;
        text-align: center;
        font-size: 35px;
        text-transform: uppercase;
        color: rgb(20, 20, 20);
        font-weight: bold;
        
        /* Border and background */
        background-color: #F5F5F0;
        border: 2px solid rgb(20, 20, 20);
        border-radius: 8px;
        padding: 8px 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        
        /* Keep on one line and adjust size */
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        width: auto;
        max-width: 90%;
        display: inline-block;
    }
#print-area-2 .address { 
        top: 75%; 
        left: 50%; 
        transform: translateX(-50%);
        width: 85%; 
        text-align: center;
        line-height: 1.3; 
        font-size: 20px;
        color: rgb(80, 80, 80);
        font-weight: bold;
        
        /* Border and background */
        background-color: #F5F5F0;
        border: 2px solid rgb(80, 80, 80);
        border-radius: 8px;
        padding: 12px 16px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
#print-area-2 .id-number { 
        top: 43%; 
        left: 50%; 
        transform: translateX(-50%);
        text-align: center;
        font-size: 30px;
        color: #000000 !important;
        -webkit-font-smoothing: antialiased;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
        
        /* Border and background */
        background-color: #F5F5F0;
        border: 2px solid #FFFFFF;
        border-radius: 5px;
        padding: 6px 6px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        
        /* Fixed width */
        width: 270px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    /* Hide unused fields in Print Area 2 */
    #print-area-2 .dob,
    #print-area-2 .gender,
    #print-area-2 .or-number,
    #print-area-2 .height,
    #print-area-2 .weight,
    #print-area-2 .date-issued,
    #print-area-2 .expiry-date {
        display: none;
    }
}
</style>


<div class="card shadow mb-4">
	<div class="card-header py-3 d-flex justify-content-between align-items-center">
		<h6 class="m-0 font-weight-bold text-dark">ID Cards</h6>

<div class="btn-group" role="group" aria-label="ID Card actions">

    <button type="button"
            class="btn btn-success btn-sm"
            data-toggle="modal"
            data-target="#importIdCardZipModal">
        <i class="fas fa-file-import"></i> Import ZIP
    </button>

      <a href="{% url 'export-idcards' %}" class="btn btn-danger btn-sm">
        <i class="fas fa-file-export"></i> Export ZIP
    </a>

        <!-- Add ID Card -->
    <button type="button"
            class="btn btn-info btn-sm"
            data-toggle="modal"
            data-target="#addIdCardModal">
        <i class="fas fa-plus"></i> Add ID Card
    </button>
</div>


	</div>
	<div class="card-body">
		<div class="table-responsive">
			<table class="table table-bordered table-hover" id="dataTable" width="100%" cellspacing="0">
				<thead>
					<tr>
					  <th class="image-col">Image</th>
						<th>ID Number</th>
						<th>Name</th>
						<th>Gender</th>
						<th>Date of Birth</th>
						<th>Address</th>
						<th>OR No</th>
						<th>Height (cm)</th>
						<th>Weight (kg)</th>
						<th>Date Issued</th>
						<th>Expiry Date</th>
            <th class="text-center">Action</th>
            
					</tr>

          <tr>
            <th class="image-col"></th>
            <th><input type="text" class="form-control form-control-sm border-secondary" /></th>
            <th><input type="text" class="form-control form-control-sm border-secondary" /></th>
            <th><input type="text" class="form-control form-control-sm border-secondary" /></th>
            <th><input type="text" class="form-control form-control-sm border-secondary" /></th>
            <th><input type="text" class="form-control form-control-sm border-secondary" /></th>
            <th><input type="text" class="form-control form-control-sm border-secondary" /></th>
            <th><input type="text" class="form-control form-control-sm border-secondary" /></th>
            <th><input type="text" class="form-control form-control-sm border-secondary" /></th>
            <th><input type="text" class="form-control form-control-sm border-secondary" /></th>
            <th><input type="text" class="form-control form-control-sm border-secondary" /></th>
            <th></th>
        </tr>
                  
				</thead>
				<tfoot>
					<tr>
						<th class="image-col">Image</th>
						<th>ID Number</th>
						<th>Name</th>
						<th>Gender</th>
						<th>Date of Birth</th>
						<th>Address</th>
						<th>OR No</th>
						<th>Height (cm)</th>
						<th>Weight (kg)</th>
						<th>Date Issued</th>
						<th>Expiry Date</th>
            <th class="text-center">Action</th>
					</tr>

          
				</tfoot>
				<tbody>
				</tbody>
			</table>
		</div>
	</div>
</div>

<!-- Add ID Card Modal -->
<div class="modal fade" id="addIdCardModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-xl" role="document">
    <div class="modal-content">

      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">
          <i class="fas fa-id-card mr-2"></i> Add ID Card
        </h5>
        <button type="button" class="close text-white" data-dismiss="modal">
          <span>&times;</span>
        </button>
      </div>

      <div class="modal-body">
        <form id="idCardForm" enctype="multipart/form-data">
          {% csrf_token %}

          <div class="row">

            <!-- COLUMN 1 -->
            <div class="col-md-4">
              <div class="form-group">
                <label class="font-weight-bold">Name</label>
                <div class="input-group">
                  <div class="input-group-prepend">
                    <span class="input-group-text"><i class="fas fa-user"></i></span>
                  </div>
                  <input name="name" class="form-control" required>
                </div>
              </div>

              <div class="form-group">
                <label class="font-weight-bold">ID Number</label>
                <div class="input-group">
                  <div class="input-group-prepend">
                    <span class="input-group-text"><i class="fas fa-hashtag"></i></span>
                  </div>
                  <input name="id_number" class="form-control" required>
                </div>
              </div>

              <div class="form-group">
                <label class="font-weight-bold">Date of Birth</label>
                <div class="input-group">
                  <div class="input-group-prepend">
                    <span class="input-group-text"><i class="fas fa-birthday-cake"></i></span>
                  </div>
                  <input type="date" name="date_of_birth" class="form-control">
                </div>
              </div>

              <div class="form-group">
                <label class="font-weight-bold">Gender</label>
                <div class="input-group">
                  <div class="input-group-prepend">
                    <span class="input-group-text"><i class="fas fa-venus-mars"></i></span>
                  </div>
                  <select name="gender" class="form-control">
                    <option value="M">Male</option>
                    <option value="F">Female</option>
                    <option value="O">Other</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- COLUMN 2 -->
            <div class="col-md-4">
              <div class="form-group">
                <label class="font-weight-bold">Address</label>
                <div class="input-group">
                  <div class="input-group-prepend">
                    <span class="input-group-text"><i class="fas fa-map-marker-alt"></i></span>
                  </div>
                  <textarea name="address" class="form-control" rows="3" required></textarea>
                </div>
              </div>

              <div class="form-group">
                <label class="font-weight-bold">OR Number</label>
                <div class="input-group">
                  <div class="input-group-prepend">
                    <span class="input-group-text"><i class="fas fa-receipt"></i></span>
                  </div>
                  <input name="or_number" class="form-control">
                </div>
              </div>

              <div class="form-group">
                <label class="font-weight-bold">Height (cm)</label>
                <div class="input-group">
                  <div class="input-group-prepend">
                    <span class="input-group-text"><i class="fas fa-ruler-vertical"></i></span>
                  </div>
                  <input name="height" class="form-control" type="number" step="0.01">
                </div>
              </div>

              <div class="form-group">
                <label class="font-weight-bold">Weight (kg)</label>
                <div class="input-group">
                  <div class="input-group-prepend">
                    <span class="input-group-text"><i class="fas fa-weight"></i></span>
                  </div>
                  <input name="weight" class="form-control" type="number" step="0.01">
                </div>
              </div>
            </div>

            <!-- COLUMN 3 -->
            <div class="col-md-4">
              <div class="form-group">
                <label class="font-weight-bold">Date Issued</label>
                <div class="input-group">
                  <div class="input-group-prepend">
                    <span class="input-group-text"><i class="fas fa-calendar-plus"></i></span>
                  </div>
                  <input type="date" name="date_issued" class="form-control">
                </div>
              </div>

              <div class="form-group">
                <label class="font-weight-bold">Expiration Date</label>
                <div class="input-group">
                  <div class="input-group-prepend">
                    <span class="input-group-text"><i class="fas fa-calendar-times"></i></span>
                  </div>
                  <input type="date" name="expiration_date" class="form-control">
                </div>
              </div>

              <div class="form-group">
                <label class="font-weight-bold">Photo</label>
                <input type="file" name="image" class="form-control-file" required>
              </div>
            </div>

          </div>
        </form>
      </div>

      <div class="modal-footer bg-light">
        <button type="button" class="btn btn-secondary btn-md" data-dismiss="modal">
          <i class="fas fa-times"></i> Close
        </button>
        <button type="button" class="btn btn-success btn-md" id="saveIdCardBtn">
          <i class="fas fa-save"></i> Save
        </button>
      </div>

    </div>
  </div>
</div>

<div id="print-area">
    <div class="id-card-wrapper">
        <img src="{% static 'assets/img/potpotfinal.png' %}" class="template-bg">
        
        <div class="data-overlay">
            <img id="print-photo" src="" class="dynamic-photo">
            <div id="print-name" class="field full-name"></div>
            <div id="print-id-number" class="field id-number"></div>
            <div id="print-address" class="field address"></div>
            <div id="print-dob" class="field dob"></div>
            <div id="print-gender" class="field gender"></div>
            <div id="print-or-number" class="field or-number"></div>
            <div id="print-height" class="field height"></div>
            <div id="print-weight" class="field weight"></div>
            <div id="print-date-issued" class="field date-issued"></div>
            <div id="print-expiry-date" class="field expiry-date"></div>
            <div id="print-dm-onate" class="field dm-onate"></div>
            <div class="signature-line"></div>
        </div>
    </div>
</div>

<div id="print-area-2">
    <div class="id-card-wrapper">
        <img src="{% static 'assets/img/modernid7.png' %}" class="template-bg">
        
        <div class="data-overlay">
            <img id="print-photo-2" src="" class="dynamic-photo">
            <div id="print-name-2" class="field full-name"></div>
            <div id="print-id-number-2" class="field id-number">ID No: </div>
            <div id="print-address-2" class="field address">Address: </div>
            <div id="print-dob-2" class="field dob"></div>
            <div id="print-gender-2" class="field gender"></div>
            <div id="print-or-number-2" class="field or-number"></div>
            <div id="print-height-2" class="field height"></div>
            <div id="print-weight-2" class="field weight"></div>
            <div id="print-date-issued-2" class="field date-issued"></div>
            <div id="print-expiry-date-2" class="field expiry-date"></div>
        </div>
    </div>
</div>
<!-- View ID Card Modal -->
<div class="modal fade" id="viewIdCardModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title text-dark">ID Card Details</h5>
        <button type="button" class="close" data-dismiss="modal">
          <span>&times;</span>
        </button>
      </div>

      <div class="modal-body">
        <div class="row">
          
          <!-- Photo Column -->
          <div class="col-md-4 text-center mb-3">
            <img id="view-image" src="" alt="ID Photo" class="img-fluid rounded" style="max-height: 280px; object-fit: cover; border: 1px solid #dee2e6;">
          </div>

          <!-- Details Column -->
          <div class="col-md-8">
            <table class="table table-sm">
              <tbody>
                <tr>
                  <td class="text-muted" style="width: 35%;">Full Name</td>
                  <td id="view-name"></td>
                </tr>
                <tr>
                  <td class="text-muted">ID Number</td>
                  <td id="view-id-number"></td>
                </tr>
                <tr>
                  <td class="text-muted">Gender</td>
                  <td id="view-gender"></td>
                </tr>
                <tr>
                  <td class="text-muted">Date of Birth</td>
                  <td id="view-dob"></td>
                </tr>
                <tr>
                  <td class="text-muted">Address</td>
                  <td id="view-address"></td>
                </tr>
                <tr>
                  <td class="text-muted">Height</td>
                  <td id="view-height"></td>
                </tr>
                <tr>
                  <td class="text-muted">Weight</td>
                  <td id="view-weight"></td>
                </tr>
                <tr>
                  <td class="text-muted">OR Number</td>
                  <td id="view-or-number"></td>
                </tr>
                <tr>
                  <td class="text-muted">Date Issued</td>
                  <td id="view-date-issued"></td>
                </tr>
                <tr>
                  <td class="text-muted">Expiry Date</td>
                  <td id="view-expiry-date"></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary btn-sm" data-dismiss="modal">Close</button>
      </div>

    </div>
  </div>
</div>

<!-- Update ID Card Modal -->
<div class="modal fade" id="updateIdCardModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-xl" role="document">
    <div class="modal-content">

      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">
          <i class="fas fa-edit mr-2"></i> Update ID Card
        </h5>
        <button type="button" class="close text-white" data-dismiss="modal">
          <span>&times;</span>
        </button>
      </div>

      <div class="modal-body">
        <form id="updateIdCardForm" enctype="multipart/form-data">
          {% csrf_token %}
          <input type="hidden" id="update-card-id" name="card_id">

          <div class="row">

            <!-- COLUMN 1 -->
            <div class="col-md-4">
              <div class="form-group">
                <label class="font-weight-bold">Name</label>
                <div class="input-group">
                  <div class="input-group-prepend">
                    <span class="input-group-text"><i class="fas fa-user"></i></span>
                  </div>
                  <input id="update-name" name="name" class="form-control" required>
                </div>
              </div>

              <div class="form-group">
                <label class="font-weight-bold">ID Number</label>
                <div class="input-group">
                  <div class="input-group-prepend">
                    <span class="input-group-text"><i class="fas fa-hashtag"></i></span>
                  </div>
                  <input id="update-id-number" name="id_number" class="form-control" required>
                </div>
              </div>

              <div class="form-group">
                <label class="font-weight-bold">Date of Birth</label>
                <div class="input-group">
                  <div class="input-group-prepend">
                    <span class="input-group-text"><i class="fas fa-birthday-cake"></i></span>
                  </div>
                  <input id="update-dob" type="date" name="date_of_birth" class="form-control">
                </div>
              </div>

              <div class="form-group">
                <label class="font-weight-bold">Gender</label>
                <div class="input-group">
                  <div class="input-group-prepend">
                    <span class="input-group-text"><i class="fas fa-venus-mars"></i></span>
                  </div>
                  <select id="update-gender" name="gender" class="form-control">
                    <option value="M">Male</option>
                    <option value="F">Female</option>
                    <option value="O">Other</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- COLUMN 2 -->
            <div class="col-md-4">
              <div class="form-group">
                <label class="font-weight-bold">Address</label>
                <div class="input-group">
                  <div class="input-group-prepend">
                    <span class="input-group-text"><i class="fas fa-map-marker-alt"></i></span>
                  </div>
                  <textarea id="update-address" name="address" class="form-control" rows="3" required></textarea>
                </div>
              </div>

              <div class="form-group">
                <label class="font-weight-bold">OR Number</label>
                <div class="input-group">
                  <div class="input-group-prepend">
                    <span class="input-group-text"><i class="fas fa-receipt"></i></span>
                  </div>
                  <input id="update-or-number" name="or_number" class="form-control">
                </div>
              </div>

              <div class="form-group">
                <label class="font-weight-bold">Height (cm)</label>
                <div class="input-group">
                  <div class="input-group-prepend">
                    <span class="input-group-text"><i class="fas fa-ruler-vertical"></i></span>
                  </div>
                  <input id="update-height" name="height" class="form-control" type="number" step="0.01">
                </div>
              </div>

              <div class="form-group">
                <label class="font-weight-bold">Weight (kg)</label>
                <div class="input-group">
                  <div class="input-group-prepend">
                    <span class="input-group-text"><i class="fas fa-weight"></i></span>
                  </div>
                  <input id="update-weight" name="weight" class="form-control" type="number" step="0.01">
                </div>
              </div>
            </div>

            <!-- COLUMN 3 -->
            <div class="col-md-4">
              <div class="form-group">
                <label class="font-weight-bold">Date Issued</label>
                <div class="input-group">
                  <div class="input-group-prepend">
                    <span class="input-group-text"><i class="fas fa-calendar-plus"></i></span>
                  </div>
                  <input id="update-date-issued" type="date" name="date_issued" class="form-control">
                </div>
              </div>

              <div class="form-group">
                <label class="font-weight-bold">Expiration Date</label>
                <div class="input-group">
                  <div class="input-group-prepend">
                    <span class="input-group-text"><i class="fas fa-calendar-times"></i></span>
                  </div>
                  <input id="update-expiry-date" type="date" name="expiration_date" class="form-control">
                </div>
              </div>

              <div class="form-group">
                <label class="font-weight-bold">Current Photo</label>
                <div class="mb-2">
                  <img id="update-current-photo" src="" alt="Current Photo" class="img-thumbnail" style="max-height: 100px;">
                </div>
                <label class="font-weight-bold">Change Photo (optional)</label>
                <input id="update-image" type="file" name="image" class="form-control-file">
              </div>
            </div>

          </div>
        </form>
      </div>

      <div class="modal-footer bg-light">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">
          <i class="fas fa-times"></i> Cancel
        </button>
        <button type="button" class="btn btn-success" id="updateIdCardBtn">
          <i class="fas fa-check"></i> Update
        </button>
      </div>

    </div>
  </div>
</div>

<!-- Print Confirmation Modal -->
<div class="modal fade" id="printConfirmModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title">Print ID Card</h5>
        <button type="button" class="close text-white" data-dismiss="modal">
          <span>&times;</span>
        </button>
      </div>

      <div class="modal-body text-center">

<button type="button" class="btn btn-primary btn-sm btn-block mb-3" id="printId1Btn">
  <i class="fas fa-id-card"></i><br>
  <strong>Print ID 1</strong><br>
  <small class="text-white">With Real Data</small>
</button>

<button type="button" class="btn btn-secondary btn-sm btn-block" id="printId2Btn">
  <i class="fas fa-id-card-alt"></i><br>
  <strong>Print ID 2</strong><br>
  <small class="text-white">Sample Template</small>
</button>

</div>


      <div class="modal-footer justify-content-center">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
      </div>

    </div>
  </div>
</div>

<!-- Image Preview Modal -->
<div class="modal fade" id="imagePreviewModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Image Preview</h5>
        <button type="button" class="close" data-dismiss="modal">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body text-center">
        <img id="preview-image" src="" alt="Preview" class="img-fluid" style="max-width: 100%; height: auto;">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Import ID Card ZIP Modal -->
<div class="modal fade" id="importIdCardZipModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">
          <i class="fas fa-file-import mr-2"></i> Import ID Cards
        </h5>
        <button type="button" class="close text-white" data-dismiss="modal">
          <span>&times;</span>
        </button>
      </div>

      <div class="modal-body">
        <form id="importIdCardZipForm" enctype="multipart/form-data" action="{% url 'import-idcards' %}" method="POST">
          {% csrf_token %}
          <div class="form-group">
            <label class="font-weight-bold">Select ZIP File</label>
            <small class="form-text text-muted d-block mb-2">
              Upload a ZIP file containing id_cards.csv and an images folder
            </small>
            <input type="file" name="zip_file" class="form-control-file" accept=".zip" required>
          </div>
          <div class="alert alert-info" role="alert">
            <small>
              <strong>Expected ZIP structure:</strong><br>
              - id_cards.csv<br>
              - images/<br>
              &nbsp;&nbsp;- image1.jpg<br>
              &nbsp;&nbsp;- image2.jpg<br>
              etc.
            </small>
          </div>
        </form>
      </div>

      <div class="modal-footer bg-light">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">
          <i class="fas fa-times"></i> Cancel
        </button>
        <button type="button" class="btn btn-success" id="importIdCardZipBtn">
          <i class="fas fa-check"></i> Import
        </button>
      </div>
    </div>
  </div>
</div>

<script>
document.getElementById("importIdCardZipBtn").addEventListener("click", function () {
    document.getElementById("importIdCardZipForm").submit();
});

function showImagePreview(imageUrl) {
    document.getElementById('preview-image').src = imageUrl;
    $('#imagePreviewModal').modal('show');
}

function openUpdateModal(cardId, imageUrl, name, idNumber, gender, dob, address, orNumber, height, weight, dateIssued, expiryDate) {
    document.getElementById('update-card-id').value = cardId;
    document.getElementById('update-name').value = name || '';  
    document.getElementById('update-id-number').value = idNumber || '';
    document.getElementById('update-gender').value = gender || 'M';
    document.getElementById('update-dob').value = formatDateForInput(dob);
    document.getElementById('update-address').value = address || '';
    document.getElementById('update-or-number').value = orNumber || '';
    document.getElementById('update-height').value = height || '';
    document.getElementById('update-weight').value = weight || '';
    document.getElementById('update-date-issued').value = formatDateForInput(dateIssued);
    document.getElementById('update-expiry-date').value = formatDateForInput(expiryDate);
    document.getElementById('update-current-photo').src = imageUrl || '';
    $('#updateIdCardModal').modal('show');
}

function formatDateForInput(dateStr) {
    if (!dateStr || dateStr === 'None' || dateStr === 'null') return '';
    if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) return dateStr;
    const date = new Date(dateStr);
    if (!isNaN(date.getTime())) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }
    return '';
}

function viewIdCard(imageUrl, name, idNumber, gender, dob, address, orNumber, height, weight, dateIssued, expiryDate) {
    document.getElementById('view-image').src = imageUrl || '';
    document.getElementById('view-name').textContent = name || 'N/A';
    document.getElementById('view-id-number').textContent = idNumber || 'N/A';
    document.getElementById('view-gender').textContent = gender || 'N/A';
    document.getElementById('view-dob').textContent = dob || 'N/A';
    document.getElementById('view-address').textContent = address || 'N/A';
    document.getElementById('view-height').textContent = height ? height + ' cm' : 'N/A';
    document.getElementById('view-weight').textContent = weight ? weight + ' kg' : 'N/A';
    document.getElementById('view-or-number').textContent = orNumber || 'N/A';
    document.getElementById('view-date-issued').textContent = dateIssued || 'N/A';
    document.getElementById('view-expiry-date').textContent = expiryDate || 'N/A';
    $('#viewIdCardModal').modal('show');
}

document.addEventListener("DOMContentLoaded", function () {

    var table = $('#dataTable').DataTable({
        "processing": true,
        "serverSide": true,
        "ajax": {
            "url": "{% url 'id-cards-datatable' %}",
            "type": "GET"
        },
        "pageLength": 10,
        "lengthChange": false,
        "ordering": false,
        "searching": true,
        "dom": 'lrtip',
        "columns": [
            { "data": 0, "orderable": false, "searchable": false },  // Image
            { "data": 1 },  // ID Number
            { "data": 2 },  // Name
            { "data": 3 },  // Gender
            { "data": 4 },  // DOB
            { "data": 5 },  // Address
            { "data": 6, "visible": false, "searchable": true },  // OR No
            { "data": 7, "visible": false, "searchable": true },  // Height
            { "data": 8, "visible": false, "searchable": true },  // Weight
            { "data": 9, "visible": false, "searchable": true },  // Date Issued
            { "data": 10, "visible": false, "searchable": true }, // Expiry
            { "data": 11, "orderable": false, "searchable": false } // Action
        ]
    });

    // Column search inputs
    table.columns().every(function(index) {
        var that = this;
        if (index === 0 || index === 11) return;
        $('input', this.header()).on('keyup change clear', function() {
            if (that.search() !== this.value) {
                that.search(this.value).draw();
            }
        });
    });

    // VIEW button - event delegation
    $('#dataTable tbody').on('click', '.btn-view-card', function() {
        var d = $(this).data();
        viewIdCard(d.image, d.name, d.idnumber, d.gender, d.dob, d.address, d.ornumber, d.height, d.weight, d.dateissued, d.expiry);
    });

    // UPDATE button - event delegation
    $('#dataTable tbody').on('click', '.btn-update-card', function() {
        var d = $(this).data();
        openUpdateModal(d.id, d.image, d.name, d.idnumber, d.gender, d.dob, d.address, d.ornumber, d.height, d.weight, d.dateissued, d.expiry);
    });

    // PRINT button - event delegation
    $('#dataTable tbody').on('click', '.btn-print-card', function() {
        var d = $(this).data();
        preparePrint(d.image, d.name, d.idnumber, d.address, d.dob, d.gender, d.ornumber, d.height, d.weight, d.dateissued, d.expiry, d.dmonate);
    });

    // Save Add ID Card
    document.getElementById("saveIdCardBtn").addEventListener("click", function () {
        let form = document.getElementById("idCardForm");
        let formData = new FormData(form);

        fetch("{% url 'add-idcard' %}", {
            method: "POST",
            body: formData,
            headers: { "X-CSRFToken": "{{ csrf_token }}" }
        })
        .then(response => {
            if (response.ok) {
                $('#addIdCardModal').modal('hide');
                table.ajax.reload();
            }
        })
        .catch(err => console.error(err));
    });

    // Save Update ID Card
    document.getElementById("updateIdCardBtn").addEventListener("click", function () {
        let form = document.getElementById("updateIdCardForm");
        let formData = new FormData(form);

        fetch("{% url 'update-idcard' %}", {
            method: "POST",
            body: formData,
            headers: { "X-CSRFToken": "{{ csrf_token }}" }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                $('#updateIdCardModal').modal('hide');
                table.ajax.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(err => console.error(err));
    });

    // Print buttons
    document.getElementById("printId1Btn").addEventListener("click", function () {
        executePrint(1);
    });
    document.getElementById("printId2Btn").addEventListener("click", function () {
        executePrint(2);
    });

});

// Print functions (global scope)
let pendingPrintData = null;

function preparePrint(photoUrl, fullName, idNum, address, dob, gender, orNumber, height, weight, dateIssued, expiryDate, dmOnate) {
    pendingPrintData = { photoUrl, fullName, idNum, address, dob, gender, orNumber, height, weight, dateIssued, expiryDate, dmOnate };
    $('#printConfirmModal').modal('show');
}

function executePrint(idType) {
    if (!pendingPrintData) return;
    const data = pendingPrintData;

    document.getElementById('print-area').classList.remove('active');
    document.getElementById('print-area-2').classList.remove('active');

    if (idType === 1) {
        document.getElementById('print-photo').src = data.photoUrl;
        document.getElementById('print-name').innerText = data.fullName;
        document.getElementById('print-id-number').innerText = data.idNum;
        document.getElementById('print-address').innerText = data.address;
        document.getElementById('print-dob').innerText = data.dob;
        document.getElementById('print-gender').innerText = data.gender || '';
        document.getElementById('print-or-number').innerText = data.orNumber || '';
        document.getElementById('print-height').innerText = data.height ? data.height + ' cm' : '';
        document.getElementById('print-weight').innerText = data.weight ? data.weight + ' kg' : '';
        document.getElementById('print-date-issued').innerText = data.dateIssued || '';
        document.getElementById('print-expiry-date').innerText = data.expiryDate || '';
        document.getElementById('print-dm-onate').innerText = data.dmOnate || '';
        document.getElementById('print-area').classList.add('active');
        triggerPrintAfterImageLoad(document.getElementById('print-photo'));
    } else if (idType === 2) {
        document.getElementById('print-photo-2').src = data.photoUrl;
        document.getElementById('print-name-2').innerText = data.fullName;
        document.getElementById('print-id-number-2').innerText = 'ID No: ' + data.idNum;
        document.getElementById('print-address-2').innerText = 'Address: ' + data.address;
        document.getElementById('print-area-2').classList.add('active');
        triggerPrintAfterImageLoad(document.getElementById('print-photo-2'));
    }
}

function triggerPrintAfterImageLoad(photoElement) {
    let printed = false;
    const triggerPrint = () => {
        if (!printed) {
            printed = true;
            $('#printConfirmModal').modal('hide');
            setTimeout(() => {
                window.print();
                document.getElementById('print-area').classList.remove('active');
                document.getElementById('print-area-2').classList.remove('active');
                pendingPrintData = null;
            }, 300);
        }
    };
    if (photoElement.complete && photoElement.naturalHeight !== 0) {
        triggerPrint();
    } else {
        photoElement.onload = triggerPrint;
        photoElement.onerror = () => { triggerPrint(); };
    }
}
</script>

{% endblock %}
{% extends 'myapp/base.html' %}
{% load static %}
{% block content %}
<style>
/* Fixed image column */
.table td.image-col,
.table th.image-col {
    width: 70px;
    text-align: center;
    vertical-align: middle;
    padding: 6px;
}

/* Thumbnail styling */
.id-thumb {
    width: 48px;
    height: 48px;
    object-fit: contain; /* IMPORTANT: no ugly crop */
    border-radius: 6px;
    background-color: #f8f9fc;
    border: 1px solid #e3e6f0;
    padding: 2px;
}
/* Styling for the Print Templates */
#print-area, #print-area-2 { display: none; }

@media print {
    body * { visibility: hidden; }
    
    /* Only show the active print area */
    #print-area.active, #print-area.active *,
    #print-area-2.active, #print-area-2.active * { 
        visibility: visible; 
    }
    
    #print-area.active, #print-area-2.active {
        display: flex !important;
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        justify-content: center; align-items: center;
        background: white;
    }

    /* ============================
       PRINT AREA 1 STYLING
    ============================ */
    #print-area .id-card-wrapper {
        position: relative;
        width: 640px;
        height: 1000px;
    }

    #print-area .template-bg { 
        width: 100%; 
        height: auto; 
        display: block; 
    }

    /* Print Area 1 - Dynamic Photo */
    #print-area .dynamic-photo {
        position: absolute;
        top: 28.5%;
        left: 21.5%;
        transform: translateX(-50%);
        width: 240px;
        height: 225px;
        object-fit: cover;
    }

    /* Print Area 1 - Text Fields */
    #print-area .field {
        position: absolute;
        font-family: Arial, sans-serif;
        font-weight: bold;
        color: rgb(37, 35, 35);
        font-size: 24px;
    }
    
    #print-area .full-name {
        top: 31%;
        left: 70%;
        transform: translateX(-50%);
        width: 100%;
        text-align: center;
        font-size: 24px;
        text-transform: uppercase;
        color: rgb(37, 35, 35);
    }

    #print-area .id-number { top: 52.3%; left: 15%; }
    #print-area .address   { top: 61.8%; left: 21%; width: 50%; line-height: 1.1; }
    #print-area .dob       { top: 76.8%; left: 2%; }
    #print-area .gender    { top: 76.8%; left: 38%; }
    #print-area .or-number { top: 89%; left: 2%; }
    #print-area .height    { top: 76.8%; left: 55%; }
    #print-area .weight    { top: 76.8%; left: 83%; }
    #print-area .date-issued  { top: 89%; left: 32.5%; }
    #print-area .expiry-date  { top: 89%; left: 73%; }

    /* ============================
       PRINT AREA 2 STYLING
    ============================ */
    #print-area-2 .id-card-wrapper {
        position: relative;
        width: 640px;
        height: 1000px;
    }

    #print-area-2 .template-bg { 
        width: 100%; 
        height: auto; 
        display: block; 
    }

    /* Print Area 2 - Dynamic Photo */
    #print-area-2 .dynamic-photo {
        position: absolute;
        top: 16%;
        left: 50%;
        transform: translateX(-50%);
        width: 257px;
        height: 257px;
        object-fit: cover;
        border-radius: 8px;
    }

    /* Print Area 2 - Text Fields */
    #print-area-2 .field {
        position: absolute;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        font-weight: 600;
        color: rgb(20, 20, 20);
        font-size: 26px;
    }
   #print-area-2 .full-name {
        top: 59.1%;
        left: 50%;
        transform: translateX(-50%);
        width: 90%;
        text-align: center;
        font-size: 35px;
        text-transform: uppercase;
        color: rgb(20, 20, 20);
        font-weight: bold;
        
        /* Border and background */
        background-color: #F5F5F0;
        border: 2px solid rgb(20, 20, 20);
        border-radius: 8px;
        padding: 8px 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        
        /* Keep on one line and adjust size */
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        width: auto;
        max-width: 90%;
        display: inline-block;
    }
#print-area-2 .address { 
        top: 75%; 
        left: 50%; 
        transform: translateX(-50%);
        width: 85%; 
        text-align: center;
        line-height: 1.3; 
        font-size: 20px;
        color: rgb(80, 80, 80);
        font-weight: bold;
        
        /* Border and background */
        background-color: #F5F5F0;
        border: 2px solid rgb(80, 80, 80);
        border-radius: 8px;
        padding: 12px 16px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
#print-area-2 .id-number { 
        top: 43%; 
        left: 50%; 
        transform: translateX(-50%);
        text-align: center;
        font-size: 30px;
        color: #000000 !important;
        -webkit-font-smoothing: antialiased;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
        
        /* Border and background */
        background-color: #F5F5F0;
        border: 2px solid #FFFFFF;
        border-radius: 5px;
        padding: 6px 6px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        
        /* Fixed width */
        width: 270px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    /* Hide unused fields in Print Area 2 */
    #print-area-2 .dob,
    #print-area-2 .gender,
    #print-area-2 .or-number,
    #print-area-2 .height,
    #print-area-2 .weight,
    #print-area-2 .date-issued,
    #print-area-2 .expiry-date {
        display: none;
    }
}
</style>


<div class="card shadow mb-4">
	<div class="card-header py-3 d-flex justify-content-between align-items-center">
		<h6 class="m-0 font-weight-bold text-primary">ID Cards</h6>
<!-- Button to trigger modal -->
<button type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#addIdCardModal">
    <i class="fas fa-plus"></i> Add ID Card
</button>


	</div>
	<div class="card-body">
		<div class="table-responsive">
			<table class="table table-bordered table-hover" id="dataTable" width="100%" cellspacing="0">
				<thead>
					<tr>
					  <th class="image-col">Image</th>
						<th>ID Number</th>
						<th>Name</th>
						<th>Gender</th>
						<th>Date of Birth</th>
						<th>Address</th>
						<th>OR No</th>
						<th>Height (cm)</th>
						<th>Weight (kg)</th>
						<th>Date Issued</th>
						<th>Expiry Date</th>
            <th class="text-center">Action</th>
            
					</tr>

          <tr>
            <th class="image-col"></th>
            <th><input type="text" class="form-control form-control-sm border-secondary" /></th>
            <th><input type="text" class="form-control form-control-sm border-secondary" /></th>
            <th><input type="text" class="form-control form-control-sm border-secondary" /></th>
            <th><input type="text" class="form-control form-control-sm border-secondary" /></th>
            <th><input type="text" class="form-control form-control-sm border-secondary" /></th>
            <th><input type="text" class="form-control form-control-sm border-secondary" /></th>
            <th><input type="text" class="form-control form-control-sm border-secondary" /></th>
            <th><input type="text" class="form-control form-control-sm border-secondary" /></th>
            <th><input type="text" class="form-control form-control-sm border-secondary" /></th>
            <th><input type="text" class="form-control form-control-sm border-secondary" /></th>
            <th></th>
        </tr>
                  
				</thead>
				<tfoot>
					<tr>
						<th class="image-col">Image</th>
						<th>ID Number</th>
						<th>Name</th>
						<th>Gender</th>
						<th>Date of Birth</th>
						<th>Address</th>
						<th>OR No</th>
						<th>Height (cm)</th>
						<th>Weight (kg)</th>
						<th>Date Issued</th>
						<th>Expiry Date</th>
            <th class="text-center">Action</th>
					</tr>

          
				</tfoot>
				<tbody>
					{% for card in cards %}
					<tr>
      <td class="image-col">
          {% if card.image %}
              <img src="{{ card.image.url }}" alt="{{ card.name }}" class="id-thumb" 
                  style="cursor: pointer;" 
                  onclick="showImagePreview('{{ card.image.url }}')">
          {% else %}
              <span class="text-muted">-</span>
          {% endif %}
      </td>

						<td>{{ card.id_number }}</td>
						<td>{{ card.name }}</td>
						<td>{{ card.get_gender_display }}</td>
						<td>{{ card.date_of_birth }}</td>
						<td class="wrap-col">{{ card.address }}</td>
						<td>{{ card.or_number }}</td>
						<td>{{ card.height }}</td>
						<td>{{ card.weight }}</td>
						<td>{{ card.date_issued }}</td>
						<td>{{ card.expiration_date }}</td>
            <td class="text-center">
            <div class="btn-group btn-group-sm" role="group">
            <button type="button" class="btn btn-info" title="View"
                onclick="viewIdCard(
                    '{{ card.image.url }}',
                    '{{ card.name|escapejs }}',
                    '{{ card.id_number }}',
                    '{{ card.get_gender_display }}',
                    '{{ card.date_of_birth }}',
                    '{{ card.address|escapejs }}',
                    '{{ card.or_number }}',
                    '{{ card.height }}',
                    '{{ card.weight }}',
                    '{{ card.date_issued }}',
                    '{{ card.expiration_date }}'
                )">
            <i class="fas fa-eye"></i>
        </button>
             <button type="button" class="btn btn-warning" title="Update"
                onclick="openUpdateModal(
                    '{{ card.id }}',
                    '{{ card.image.url }}',
                    '{{ card.name|escapejs }}',
                    '{{ card.id_number }}',
                    '{{ card.gender }}',
                    '{{ card.date_of_birth }}',
                    '{{ card.address|escapejs }}',
                    '{{ card.or_number }}',
                    '{{ card.height }}',
                    '{{ card.weight }}',
                    '{{ card.date_issued }}',
                    '{{ card.expiration_date }}'
                )">
            <i class="fas fa-edit"></i>
        </button>

              <button type="button" class="btn btn-danger" title="Delete">
                <i class="fas fa-trash"></i>
              </button>
        <button type="button" class="btn btn-secondary" title="Print" 
                onclick="preparePrint(
            '{{ card.image.url }}',
            '{{ card.name|escapejs }}',
            '{{ card.id_number }}',
            '{{ card.address|escapejs }}',
            '{{ card.date_of_birth }}',
            '{{ card.get_gender_display }}',
            '{{ card.or_number }}',
            '{{ card.height }}',
            '{{ card.weight }}',
            '{{ card.date_issued }}',
            '{{ card.expiration_date }}'
        )">
        <i class="fas fa-print"></i>
        </button>
            </div>
          </td>
					</tr>
					{% empty %}
					<tr>
						<td colspan="11" class="text-center text-muted">No ID cards found.</td>
					</tr>
					{% endfor %}
				</tbody>
			</table>
		</div>
	</div>
</div>

<!-- Add ID Card Modal -->
<div class="modal fade" id="addIdCardModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-xl" role="document">
    <div class="modal-content">

      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">
          <i class="fas fa-id-card mr-2"></i> Add ID Card
        </h5>
        <button type="button" class="close text-white" data-dismiss="modal">
          <span>&times;</span>
        </button>
      </div>

      <div class="modal-body">
        <form id="idCardForm" enctype="multipart/form-data">
          {% csrf_token %}

          <div class="row">

            <!-- COLUMN 1 -->
            <div class="col-md-4">
              <div class="form-group">
                <label class="font-weight-bold">Name</label>
                <div class="input-group">
                  <div class="input-group-prepend">
                    <span class="input-group-text"><i class="fas fa-user"></i></span>
                  </div>
                  <input name="name" class="form-control" required>
                </div>
              </div>

              <div class="form-group">
                <label class="font-weight-bold">ID Number</label>
                <div class="input-group">
                  <div class="input-group-prepend">
                    <span class="input-group-text"><i class="fas fa-hashtag"></i></span>
                  </div>
                  <input name="id_number" class="form-control" required>
                </div>
              </div>

              <div class="form-group">
                <label class="font-weight-bold">Date of Birth</label>
                <div class="input-group">
                  <div class="input-group-prepend">
                    <span class="input-group-text"><i class="fas fa-birthday-cake"></i></span>
                  </div>
                  <input type="date" name="date_of_birth" class="form-control">
                </div>
              </div>

              <div class="form-group">
                <label class="font-weight-bold">Gender</label>
                <div class="input-group">
                  <div class="input-group-prepend">
                    <span class="input-group-text"><i class="fas fa-venus-mars"></i></span>
                  </div>
                  <select name="gender" class="form-control">
                    <option value="M">Male</option>
                    <option value="F">Female</option>
                    <option value="O">Other</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- COLUMN 2 -->
            <div class="col-md-4">
              <div class="form-group">
                <label class="font-weight-bold">Address</label>
                <div class="input-group">
                  <div class="input-group-prepend">
                    <span class="input-group-text"><i class="fas fa-map-marker-alt"></i></span>
                  </div>
                  <textarea name="address" class="form-control" rows="3" required></textarea>
                </div>
              </div>

              <div class="form-group">
                <label class="font-weight-bold">OR Number</label>
                <div class="input-group">
                  <div class="input-group-prepend">
                    <span class="input-group-text"><i class="fas fa-receipt"></i></span>
                  </div>
                  <input name="or_number" class="form-control">
                </div>
              </div>

              <div class="form-group">
                <label class="font-weight-bold">Height (cm)</label>
                <div class="input-group">
                  <div class="input-group-prepend">
                    <span class="input-group-text"><i class="fas fa-ruler-vertical"></i></span>
                  </div>
                  <input name="height" class="form-control" type="number" step="0.01">
                </div>
              </div>

              <div class="form-group">
                <label class="font-weight-bold">Weight (kg)</label>
                <div class="input-group">
                  <div class="input-group-prepend">
                    <span class="input-group-text"><i class="fas fa-weight"></i></span>
                  </div>
                  <input name="weight" class="form-control" type="number" step="0.01">
                </div>
              </div>
            </div>

            <!-- COLUMN 3 -->
            <div class="col-md-4">
              <div class="form-group">
                <label class="font-weight-bold">Date Issued</label>
                <div class="input-group">
                  <div class="input-group-prepend">
                    <span class="input-group-text"><i class="fas fa-calendar-plus"></i></span>
                  </div>
                  <input type="date" name="date_issued" class="form-control">
                </div>
              </div>

              <div class="form-group">
                <label class="font-weight-bold">Expiration Date</label>
                <div class="input-group">
                  <div class="input-group-prepend">
                    <span class="input-group-text"><i class="fas fa-calendar-times"></i></span>
                  </div>
                  <input type="date" name="expiration_date" class="form-control">
                </div>
              </div>

              <div class="form-group">
                <label class="font-weight-bold">Photo</label>
                <input type="file" name="image" class="form-control-file" required>
              </div>
            </div>

          </div>
        </form>
      </div>

      <div class="modal-footer bg-light">
        <button type="button" class="btn btn-secondary btn-md" data-dismiss="modal">
          <i class="fas fa-times"></i> Close
        </button>
        <button type="button" class="btn btn-primary btn-md" id="saveIdCardBtn">
          <i class="fas fa-save"></i> Save
        </button>
      </div>

    </div>
  </div>
</div>

<div id="print-area">
    <div class="id-card-wrapper">
        <img src="{% static 'assets/img/potpotid-2.png' %}" class="template-bg">
        
        <div class="data-overlay">
            <img id="print-photo" src="" class="dynamic-photo">
            <div id="print-name" class="field full-name"></div>
            <div id="print-id-number" class="field id-number"></div>
            <div id="print-address" class="field address"></div>
            <div id="print-dob" class="field dob"></div>
            <div id="print-gender" class="field gender"></div>
            <div id="print-or-number" class="field or-number"></div>
            <div id="print-height" class="field height"></div>
            <div id="print-weight" class="field weight"></div>
            <div id="print-date-issued" class="field date-issued"></div>
            <div id="print-expiry-date" class="field expiry-date"></div>
        </div>
    </div>
</div>

<div id="print-area-2">
    <div class="id-card-wrapper">
        <img src="{% static 'assets/img/modernid7.png' %}" class="template-bg">
        
        <div class="data-overlay">
            <img id="print-photo-2" src="" class="dynamic-photo">
            <div id="print-name-2" class="field full-name"></div>
            <div id="print-id-number-2" class="field id-number">ID No: </div>
            <div id="print-address-2" class="field address">Address: </div>
            <div id="print-dob-2" class="field dob"></div>
            <div id="print-gender-2" class="field gender"></div>
            <div id="print-or-number-2" class="field or-number"></div>
            <div id="print-height-2" class="field height"></div>
            <div id="print-weight-2" class="field weight"></div>
            <div id="print-date-issued-2" class="field date-issued"></div>
            <div id="print-expiry-date-2" class="field expiry-date"></div>
        </div>
    </div>
</div>
<!-- View ID Card Modal -->
<div class="modal fade" id="viewIdCardModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title text-dark">ID Card Details</h5>
        <button type="button" class="close" data-dismiss="modal">
          <span>&times;</span>
        </button>
      </div>

      <div class="modal-body">
        <div class="row">
          
          <!-- Photo Column -->
          <div class="col-md-4 text-center mb-3">
            <img id="view-image" src="" alt="ID Photo" class="img-fluid rounded" style="max-height: 280px; object-fit: cover; border: 1px solid #dee2e6;">
          </div>

          <!-- Details Column -->
          <div class="col-md-8">
            <table class="table table-sm">
              <tbody>
                <tr>
                  <td class="text-muted" style="width: 35%;">Full Name</td>
                  <td id="view-name"></td>
                </tr>
                <tr>
                  <td class="text-muted">ID Number</td>
                  <td id="view-id-number"></td>
                </tr>
                <tr>
                  <td class="text-muted">Gender</td>
                  <td id="view-gender"></td>
                </tr>
                <tr>
                  <td class="text-muted">Date of Birth</td>
                  <td id="view-dob"></td>
                </tr>
                <tr>
                  <td class="text-muted">Address</td>
                  <td id="view-address"></td>
                </tr>
                <tr>
                  <td class="text-muted">Height</td>
                  <td id="view-height"></td>
                </tr>
                <tr>
                  <td class="text-muted">Weight</td>
                  <td id="view-weight"></td>
                </tr>
                <tr>
                  <td class="text-muted">OR Number</td>
                  <td id="view-or-number"></td>
                </tr>
                <tr>
                  <td class="text-muted">Date Issued</td>
                  <td id="view-date-issued"></td>
                </tr>
                <tr>
                  <td class="text-muted">Expiry Date</td>
                  <td id="view-expiry-date"></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary btn-sm" data-dismiss="modal">Close</button>
      </div>

    </div>
  </div>
</div>

<!-- Update ID Card Modal -->
<div class="modal fade" id="updateIdCardModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-xl" role="document">
    <div class="modal-content">

      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">
          <i class="fas fa-edit mr-2"></i> Update ID Card
        </h5>
        <button type="button" class="close text-white" data-dismiss="modal">
          <span>&times;</span>
        </button>
      </div>

      <div class="modal-body">
        <form id="updateIdCardForm" enctype="multipart/form-data">
          {% csrf_token %}
          <input type="hidden" id="update-card-id" name="card_id">

          <div class="row">

            <!-- COLUMN 1 -->
            <div class="col-md-4">
              <div class="form-group">
                <label class="font-weight-bold">Name</label>
                <div class="input-group">
                  <div class="input-group-prepend">
                    <span class="input-group-text"><i class="fas fa-user"></i></span>
                  </div>
                  <input id="update-name" name="name" class="form-control" required>
                </div>
              </div>

              <div class="form-group">
                <label class="font-weight-bold">ID Number</label>
                <div class="input-group">
                  <div class="input-group-prepend">
                    <span class="input-group-text"><i class="fas fa-hashtag"></i></span>
                  </div>
                  <input id="update-id-number" name="id_number" class="form-control" required>
                </div>
              </div>

              <div class="form-group">
                <label class="font-weight-bold">Date of Birth</label>
                <div class="input-group">
                  <div class="input-group-prepend">
                    <span class="input-group-text"><i class="fas fa-birthday-cake"></i></span>
                  </div>
                  <input id="update-dob" type="date" name="date_of_birth" class="form-control">
                </div>
              </div>

              <div class="form-group">
                <label class="font-weight-bold">Gender</label>
                <div class="input-group">
                  <div class="input-group-prepend">
                    <span class="input-group-text"><i class="fas fa-venus-mars"></i></span>
                  </div>
                  <select id="update-gender" name="gender" class="form-control">
                    <option value="M">Male</option>
                    <option value="F">Female</option>
                    <option value="O">Other</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- COLUMN 2 -->
            <div class="col-md-4">
              <div class="form-group">
                <label class="font-weight-bold">Address</label>
                <div class="input-group">
                  <div class="input-group-prepend">
                    <span class="input-group-text"><i class="fas fa-map-marker-alt"></i></span>
                  </div>
                  <textarea id="update-address" name="address" class="form-control" rows="3" required></textarea>
                </div>
              </div>

              <div class="form-group">
                <label class="font-weight-bold">OR Number</label>
                <div class="input-group">
                  <div class="input-group-prepend">
                    <span class="input-group-text"><i class="fas fa-receipt"></i></span>
                  </div>
                  <input id="update-or-number" name="or_number" class="form-control">
                </div>
              </div>

              <div class="form-group">
                <label class="font-weight-bold">Height (cm)</label>
                <div class="input-group">
                  <div class="input-group-prepend">
                    <span class="input-group-text"><i class="fas fa-ruler-vertical"></i></span>
                  </div>
                  <input id="update-height" name="height" class="form-control" type="number" step="0.01">
                </div>
              </div>

              <div class="form-group">
                <label class="font-weight-bold">Weight (kg)</label>
                <div class="input-group">
                  <div class="input-group-prepend">
                    <span class="input-group-text"><i class="fas fa-weight"></i></span>
                  </div>
                  <input id="update-weight" name="weight" class="form-control" type="number" step="0.01">
                </div>
              </div>
            </div>

            <!-- COLUMN 3 -->
            <div class="col-md-4">
              <div class="form-group">
                <label class="font-weight-bold">Date Issued</label>
                <div class="input-group">
                  <div class="input-group-prepend">
                    <span class="input-group-text"><i class="fas fa-calendar-plus"></i></span>
                  </div>
                  <input id="update-date-issued" type="date" name="date_issued" class="form-control">
                </div>
              </div>

              <div class="form-group">
                <label class="font-weight-bold">Expiration Date</label>
                <div class="input-group">
                  <div class="input-group-prepend">
                    <span class="input-group-text"><i class="fas fa-calendar-times"></i></span>
                  </div>
                  <input id="update-expiry-date" type="date" name="expiration_date" class="form-control">
                </div>
              </div>

              <div class="form-group">
                <label class="font-weight-bold">Current Photo</label>
                <div class="mb-2">
                  <img id="update-current-photo" src="" alt="Current Photo" class="img-thumbnail" style="max-height: 100px;">
                </div>
                <label class="font-weight-bold">Change Photo (optional)</label>
                <input id="update-image" type="file" name="image" class="form-control-file">
              </div>
            </div>

          </div>
        </form>
      </div>

      <div class="modal-footer bg-light">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">
          <i class="fas fa-times"></i> Cancel
        </button>
        <button type="button" class="btn btn-primary" id="updateIdCardBtn">
          <i class="fas fa-check"></i> Update
        </button>
      </div>

    </div>
  </div>
</div>

<!-- Print Confirmation Modal -->
<div class="modal fade" id="printConfirmModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title">Print ID Card</h5>
        <button type="button" class="close text-white" data-dismiss="modal">
          <span>&times;</span>
        </button>
      </div>

      <div class="modal-body text-center">

<button type="button" class="btn btn-primary btn-sm btn-block mb-3" id="printId1Btn">
  <i class="fas fa-id-card"></i><br>
  <strong>Print ID 1</strong><br>
  <small class="text-white">With Real Data</small>
</button>

<button type="button" class="btn btn-secondary btn-sm btn-block" id="printId2Btn">
  <i class="fas fa-id-card-alt"></i><br>
  <strong>Print ID 2</strong><br>
  <small class="text-white">Sample Template</small>
</button>

</div>


      <div class="modal-footer justify-content-center">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
      </div>

    </div>
  </div>
</div>

<!-- Image Preview Modal -->
<div class="modal fade" id="imagePreviewModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Image Preview</h5>
        <button type="button" class="close" data-dismiss="modal">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body text-center">
        <img id="preview-image" src="" alt="Preview" class="img-fluid" style="max-width: 100%; height: auto;">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script>


// Function to show image preview
function showImagePreview(imageUrl) {
    document.getElementById('preview-image').src = imageUrl;
    $('#imagePreviewModal').modal('show');
}

function openUpdateModal(cardId, imageUrl, name, idNumber, gender, dob, address, orNumber, height, weight, dateIssued, expiryDate) {
    // Fill hidden card ID
    document.getElementById('update-card-id').value = cardId;
    
    // Fill form fields
    document.getElementById('update-name').value = name || '';  
    document.getElementById('update-id-number').value = idNumber || '';
    document.getElementById('update-gender').value = gender || 'M';
    document.getElementById('update-dob').value = formatDateForInput(dob);
    document.getElementById('update-address').value = address || '';
    document.getElementById('update-or-number').value = orNumber || '';
    document.getElementById('update-height').value = height || '';
    document.getElementById('update-weight').value = weight || '';
    document.getElementById('update-date-issued').value = formatDateForInput(dateIssued);
    document.getElementById('update-expiry-date').value = formatDateForInput(expiryDate);
    
    // Show current photo
    document.getElementById('update-current-photo').src = imageUrl || '';
    
    // Show the modal
    $('#updateIdCardModal').modal('show');
}

// Helper function to format dates for input fields
function formatDateForInput(dateStr) {
    if (!dateStr || dateStr === 'None' || dateStr === 'null') return '';
    
    // If date is already in YYYY-MM-DD format, return it
    if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
        return dateStr;
    }
    
    // If date is in other formats (e.g., "Jan. 30, 2025"), convert it
    const date = new Date(dateStr);
    if (!isNaN(date.getTime())) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }
    
    return '';
}
  // Function to view ID card details
function viewIdCard(imageUrl, name, idNumber, gender, dob, address, orNumber, height, weight, dateIssued, expiryDate) {
    // Set image
    document.getElementById('view-image').src = imageUrl || '';
    
    // Set personal information
    document.getElementById('view-name').textContent = name || 'N/A';
    document.getElementById('view-id-number').textContent = idNumber || 'N/A';
    document.getElementById('view-gender').textContent = gender || 'N/A';
    document.getElementById('view-dob').textContent = dob || 'N/A';
    document.getElementById('view-address').textContent = address || 'N/A';
    
    // Set physical information
    document.getElementById('view-height').textContent = height ? height + ' cm' : 'N/A';
    document.getElementById('view-weight').textContent = weight ? weight + ' kg' : 'N/A';
    
    // Set card information
    document.getElementById('view-or-number').textContent = orNumber || 'N/A';
    document.getElementById('view-date-issued').textContent = dateIssued || 'N/A';
    document.getElementById('view-expiry-date').textContent = expiryDate || 'N/A';
    
    // Show the modal
    $('#viewIdCardModal').modal('show');
}
document.addEventListener("DOMContentLoaded", function () {
    // 1. Initialize DataTable
    var table = $('#dataTable').DataTable({
        "pageLength": 10,
        "lengthChange": false,
        "ordering": false,
        "searching": true,
        "dom": 'lrtip',
        "columnDefs": [
            {
                "targets": [6, 7, 8, 9, 10],
                "visible": false,
                "searchable": true
            }
        ]
    });

    // Apply column search from header inputs
    table.columns().every(function(index) {
        var that = this;
        // Skip Image column (0) and Action column (11)
        if (index === 0 || index === 11) {
            return;
        }
        $('input', this.header()).on('keyup change clear', function() {
            if (that.search() !== this.value) {
                that.search(this.value).draw();
            }
        });
    });

    // 2. Save ID Card button - SINGLE listener
    document.getElementById("saveIdCardBtn").addEventListener("click", function () {
        let form = document.getElementById("idCardForm");
        let formData = new FormData(form);

        fetch("{% url 'add-idcard' %}", {
            method: "POST",
            body: formData,
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
            }
        })
        .then(response => {
            if (response.ok) {
                $('#addIdCardModal').modal('hide');
                setTimeout(() => {
                    location.reload();
                }, 300);
            }
        })
        .catch(err => console.error(err));
    });


      // Add this new listener for Update button
    document.getElementById("updateIdCardBtn").addEventListener("click", function () {
        let form = document.getElementById("updateIdCardForm");
        let formData = new FormData(form);

        fetch("{% url 'update-idcard' %}", {
            method: "POST",
            body: formData,
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                $('#updateIdCardModal').modal('hide');
                setTimeout(() => {
                    location.reload();
                }, 300);
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(err => {
            console.error(err);
            alert('An error occurred while updating the ID Card');
        });
    });

    // Print ID 1 button listener// Print ID 1 button (with real data)
document.getElementById("printId1Btn").addEventListener("click", function () {
    executePrint(1);
});

// Print ID 2 button (sample template)
document.getElementById("printId2Btn").addEventListener("click", function () {
    executePrint(2);
});

    
});

// 3. Global function for print (outside DOMContentLoaded since it's called from inline onclick)

// Global variables to store print data temporarily
let pendingPrintData = null;

function preparePrint(photoUrl, fullName, idNum, address, dob, gender, orNumber, height, weight, dateIssued, expiryDate) {
    // Store the print data
    pendingPrintData = {
        photoUrl, fullName, idNum, address, dob, gender, orNumber, height, weight, dateIssued, expiryDate
    };
    
    // Update modal message with ID number
    // document.getElementById('print-confirm-message').innerText = `Print ID ${idNum}?`;
    
    // Show confirmation modal
    $('#printConfirmModal').modal('show');
}

function executePrint(idType) {
    if (!pendingPrintData) return;
    
    const data = pendingPrintData;
    
    // Remove active class from both print areas first
    document.getElementById('print-area').classList.remove('active');
    document.getElementById('print-area-2').classList.remove('active');
    
    if (idType === 1) {
        // Print ID 1 - With Real Data
        document.getElementById('print-photo').src = data.photoUrl;
        document.getElementById('print-name').innerText = data.fullName;
        document.getElementById('print-id-number').innerText = data.idNum;
        document.getElementById('print-address').innerText = data.address;
        document.getElementById('print-dob').innerText = data.dob;
        document.getElementById('print-gender').innerText = data.gender || '';
        document.getElementById('print-or-number').innerText = data.orNumber || '';
        document.getElementById('print-height').innerText = data.height ? data.height + ' cm' : '';
        document.getElementById('print-weight').innerText = data.weight ? data.weight + ' kg' : '';
        document.getElementById('print-date-issued').innerText = data.dateIssued || '';
        document.getElementById('print-expiry-date').innerText = data.expiryDate || '';
        
        // Mark ID 1 as active for printing
        document.getElementById('print-area').classList.add('active');
        
        const photo = document.getElementById('print-photo');
        triggerPrintAfterImageLoad(photo);
       }else if (idType === 2) {
        // Print ID 2 - ONLY Image, Name, ID Number, and Address (Real Data)
        document.getElementById('print-photo-2').src = data.photoUrl;
        document.getElementById('print-name-2').innerText = data.fullName;
        document.getElementById('print-id-number-2').innerText = 'ID No: ' + data.idNum;
        document.getElementById('print-address-2').innerText = 'Address: ' + data.address;
        
        // Clear all other fields (leave them empty)
        document.getElementById('print-dob-2').innerText = '';
        document.getElementById('print-gender-2').innerText = '';
        document.getElementById('print-or-number-2').innerText = '';
        document.getElementById('print-height-2').innerText = '';
        document.getElementById('print-weight-2').innerText = '';
        document.getElementById('print-date-issued-2').innerText = '';
        document.getElementById('print-expiry-date-2').innerText = '';
        
        // Mark ID 2 as active for printing
        document.getElementById('print-area-2').classList.add('active');
        
        const photo = document.getElementById('print-photo-2');
        triggerPrintAfterImageLoad(photo);
    }
}

function triggerPrintAfterImageLoad(photoElement) {
    let printed = false;

    const triggerPrint = () => {
        if (!printed) {
            printed = true;
            // Hide modal before printing
            $('#printConfirmModal').modal('hide');
            setTimeout(() => {
                window.print();
                // Clean up after printing
                document.getElementById('print-area').classList.remove('active');
                document.getElementById('print-area-2').classList.remove('active');
                pendingPrintData = null;
            }, 300);
        }
    };

    if (photoElement.complete && photoElement.naturalHeight !== 0) {
        triggerPrint();
    } else {
        photoElement.onload = triggerPrint;
        // Add error handler in case image fails to load
        photoElement.onerror = () => {
            console.error('Image failed to load');
            triggerPrint(); // Still trigger print even if image fails
        };
    }
}

</script>


{% endblock %}